<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="query">
    <target name="query">
        <!-- Create first Query object if any-->
        <echo>Configuring query object with name '${holding}-query'</echo>
        <ia-task self="querySelf">
            <object typeAlias="query" checkExistSpEL="?[name=='${holding}-query']">
                <create>
                    <name>${holding}-query</name>
                </create>
                <update>
                    <resultSchema>${pdiSchema}</resultSchema>
                    <resultRootElement>result</resultRootElement>
                    <quota>${qqSelf}</quota>
                    <quotaAsync>${qqSelf}</quotaAsync>
                    <aics>${aicSelf}</aics>
                    <aics/>
                    <order>${orderSelf}</order>
                    <namespaces>
                        <uri>${pdiSchema}</uri>
                        <prefix>n</prefix>
                    </namespaces>
                    <namespaces/>
                    <xdbPdiConfigs>
                        <schema>${pdiSchema}</schema>
                        <entityPath>/n:ArchiefDocumenten/n:ArchiefDocument</entityPath>
                        <operands>
                            <name>ArchiefDocumentId</name>
                            <path>n:ArchiefDocumentId</path>
                            <type>STRING</type>
                            <indexed>true</indexed>
                        </operands>
                        <operands>
                            <name>ArchiefPersoonsnummer</name>
                            <path>n:ArchiefPersoonsnummer</path>
                            <type>STRING</type>
                            <indexed>true</indexed>
                        </operands>
						<operands>
							<name>ArchiefDocumentSoort</name>
							<path>n:ArchiefDocumentSoort</path>
							<type>STRING</type>
							<indexed>true</indexed>
						</operands>
                        <operands>
                            <name>ArchiefVerzenddag</name>
                            <path>n:ArchiefVerzenddag</path>
                            <type>DATE</type>
                            <indexed>true</indexed>
                        </operands>
                        <template>
                            let $root := root($aiu)
                            let $aipid := xhive:metadata($root, 'aip_id')
                            return local:decrypt-tree($aiu, $aipid)
                        </template>
                    </xdbPdiConfigs>
                    <xdbPdiConfigs/>
                    <prolog>
                        declare function local:decrypt-tree($node as node(), $aipid as xs:string) as
                        node()?
                        {
                        typeswitch ( $node )
                        case element(n:ArchiefDocumentId)
                        return element { node-name($node) } { ia-fun:decrypt($node/text(), $aipid) }
                        case element()
                        return element { node-name($node) } { $node/@*,$node/node()/local:decrypt-tree(., $aipid) }
                        default
                        return $node
                        };
                    </prolog>
                </update>
            </object>
        </ia-task>
    </target>
</project>
